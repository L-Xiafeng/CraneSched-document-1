{"./":{"url":"./","title":"1 Crane简介","keywords":"","body":"Crane 简介 鸣鹤（Crane）是北京大学高性能计算校级公共平台自主研发的分布式智算调度系统，团队在总结高性能公共平台运行近六年的管理和维护经验之后，从高性能计算任务调度的资源管理、资源查看、作业提交、作业查询和资源隔离等作业调度系统最基本的需求出发，结合云计算的作业调度场景，采用C++、go等语言进行开发，完全自主研发的融合高性能计算和云计算调度为一体的开源分布式智算调度系统。 Crane开源地址：Crane，欢迎开发者一起加入。 Crane 设计理念 功能强大：支持高性能计算 + 云计算 高度可伸缩：支持百万核心集群规模 + 可同时处理10万条作业 易使用：用户友好 + 管理员易使用 安全：通信加密 + 故障率低不丢作业 高度可容错：无单点故障 + 快速故障恢复 易部署 Crane 架构 Cranectld是调度系统的“大脑”，负责集群节点生命周期的管理、作业队列的调度及管理、节点资源管理及调度，处理来自用户指令的作业提交、修改、查询等请求。 Craned是部署在计算节点上的守护进程，主要用来监控节点资源及作业状态，接受用户的各种指令，并将其发送给Cranectld，并向用户传送Cranectld的返回结果。 在设计Craned的时候，综合考量高性能计算和云计算服务的特点与不同，在资源分配的时候，设计了Resouces Manager这个对象，当 用户提交高性能计算作业时，调用Cgroup Manager这个组件，用来为高性能计算服务分配资源，并用Cgroup来隔离作业资源。 用户提交云计算作业时，调用Container Manager这个组件，基于K8S为云计算作业分配资源并打包APP 容器，并对容器生命周期进行管理。 Crane 应用场景 Crane支持高性能计算+云计算的复杂分布式计算场景，结合“东数西算”时代背景，将分布于全国各地的集群通过一个云端联通，Crane通过调度算法将用户的作业提交到最“空闲”的集群上，充分利用各集群资源，减少用户排队时间。 "},"features.html":{"url":"features.html","title":"2 Crane功能和特点","keywords":"","body":"Crane功能和特点 资源管理功能 资源查看 资源调度 资源管理（增加/减少/节点状态变化等） 资源审计（节点状态变化事件记录） 作业管理功能 作业提交 作业取消 作业修改，时间延长等 作业状态查询 作业审计 特点 完全开源 支持高性能计算与云计算两种作业模式 无单点故障，容错性高 资源和节点状态可持续化，宕机之后重启自动恢复 高度可扩展性，可以同时支持提交/取消/管理多个独立作业 高性能，每秒可处理多个作业，为作业分配资源并运行 常用命令 cinfo： 查看节点与分区状态 cbatch： 提交批量处理作业 cqueue： 查看作业队列 ccancel： 取消作业 ccontrol:查看分区和节点状态 cacctmgr： 查看和调整用户/账号信息 常用术语 job: 作业 node: 计算节点 core: CPU核 tasks： 任务数，一般一个任务使用一个CPU核，可理解为作业所需的CPU核数 partition: 分区 user: 用户名 account: 账户 stdout: 标准输出文件，程序运行正常时输出信息的文件，一般指输出到屏幕的信息 stderr: 标准错误文件，程序运行错误时输出信息的文件，一般指输出到屏幕的信息 "},"command/cinfo.html":{"url":"command/cinfo.html","title":"4.1 cinfo 查看节点与分区状态","keywords":"","body":"cinfo 查看节点与分区状态 cinfo可查询各分区节点的队列资源信息。 查看分区节点状态： cinfo cinfo运行结果展示 主要输出项 PARTITION：分区名 AVAIL： 分区状态 idel： 空闲 mix： 节点部分核心可以使用 alloc： 节点已被占用 down： 节点不可用 NODES：节点数 NODELIST： 节点列表 主要参数 --help: 显示帮助 "},"command/cbatch.html":{"url":"command/cbatch.html","title":"4.2 cbatch 提交批处理作业","keywords":"","body":"cbatch 提交批处理作业 cbatch主要是将用户描述整个计算过程的脚本传递给作业调度系统，并为作业分配作业号，等待作业调度系统为其分配资源并执行。 首先介绍一个简单的单节点作业的例子: 下列作业将申请一个节点，一个CPU核心，并在计算节点上运行hostname并退出 #!/bin/bash #CBATCH --task-per-node 1 #CBATCH --node 1 #CBATCH -c 1 #CBATCH --mem 20M #CBATCH --time 0:3:1 #CBATCH -o job.out #CBATCH -p CPU #CBATCH -J Test_Job hostname 假设上面作业脚本的文件名为crane_submit.sh，通过cbatch命令提交： cbatch crane_submit.sh cbatch运行结果展示 主要参数： --node： 申请的节点数量 --task-per-node： 每个节点上运行的任务数量 -c: 每个节点申请的CPU核心数 --mem： 每个节点申请的内存大小 --time： 作业的最长运行时间 -o： 指定作业的标准输出重定向 -p： 作业使用的分区/队列 -J： 作业名 常用环境变量 变量名 说明 CRANE_JOB_NODELIST 作业分配的节点列表 %j 作业号 下面介绍提交一个跨节点多核心的例子： 下列作业将在三个节点上运行，每个节点使用4个CPU核心。 #!/bin/bash #CBATCH -o crane_test%j.out #CBATCH -p CPU #CBATCH -J \"crane_test\" #CBATCH --node 3 ##CBATCH --task-per-node 4 #CBATCH -c 4 #CBATCH --time 50:00:00 # 生成作业分配的节点的machinefile echo \"$CRANE_JOB_NODELIST\" | tr \";\" \"\\n\" > crane.hosts #加载MPI运行环境 module load mpich/4.0 #执行跨节点并行任务 mpirun -n 13 -machinefile crane.hosts helloWorld > log "},"command/cqueue.html":{"url":"command/cqueue.html","title":"4.3 cqueue 查看作业队列","keywords":"","body":"cqueue 查看作业队列 cqueue可以查看队列中的作业信息。 查看集群中所有队列的作业信息。 cqueue cqueue运行结果展示 主要输出项 TaskId：作业名 Type： 作业类型 Status：作业状态 NodeIndex： 作业运行的节点名 主要参数 --help: 显示帮助 "},"command/ccancel.html":{"url":"command/ccancel.html","title":"4.4 ccancel 取消运行或提交的作业","keywords":"","body":"ccancel 取消作业 ccancel可以终止正在运行或者在排队中的作业。 取消作业号为280的作业： ccancel 280 ccancel运行结果展示 取消作业之后，如果被分配节点上没有用户的其他作业，作业调度系统会终止用户在所分配节点的所有进程，并取消用户在所分配节点上的ssh权限。 "},"command/ccontrol.html":{"url":"command/ccontrol.html","title":"4.5 ccontrol 查看分区和节点状态","keywords":"","body":"ccontrol 查看分区和节点状态 ccontrol可以查看分区和节点的状态。 1. 查看分区状态 ccontrol show partition ccontrol show partition运行结果展示 主要输出项 PartitionName：分区名 State：分区状态 TotalNodes：分区节点数目 AliveNodes：分区中可运行的节点数目 TotalCpus：分区中所有节点总CPU数目 AvailCpus：分区中所有可以使用的CPU数目 AllocCpus：分区中已经被分配的CPU数目 FreeCpus：分区中空闲的CPU数目 TotalMem：分区节点的总内存 AvailMem：分区中当前可以使用的内存大小 AllocMem：分区中已分配的内存大小 FreeMem：分区中空闲的内存大小 HostList：分区中所有节点的节点名列表 2. 查看节点状态 ccontrol show node ccontrol show node运行结果展示 主要输出项 NodeName：节点名 State：节点状态 IDLE： 节点空闲，可使用 DOWN： 节点宕机，不可用 CPUs：节点CPU数目 AllocCpus：节点已分配的CPU数目 FreeCpus：节点空闲的CPU数目 RealMemory：节点的实际内存大小 AllocMem：节点已经分配的内存大小 FreeMem：节点空闲的内存大小 Patition：节点所属分区 RunningTask：节点上正在运行的作业数量 "},"command/cacctmgr.html":{"url":"command/cacctmgr.html","title":"4.6 cacctmgr 管理用户/账户信息","keywords":"","body":"cacctmgr 管理用户/账户信息 cacctmgr 可以管理账户/用户信息，包括添加账户/用户、删除账户/用户、查找账户/用户。 Crane作业调度系统中有三个用户角色： 系统管理员（Admin）：可以增删查改任何账户和用户信息 账户管理员（Operator）：可以修改部分该账户信息及账户下用户信息 普通用户(None)： 仅可以查看部分信息，不可以修改所有用户和账户信息 1. 添加账户 cacctmgr add account -name=China -describe=motherland -partition=[CPU,GPU,UU] -Qos=normal 主要参数 Qos： 服务质量 describe： 账户描述信息 name： 账户名 parent： 父账户 partition： 可使用的分区名 2. 添加用户 系统管理员可以添加任意账户的用户， 账号管理员可以添加同一账号下的新用户。 cacctmgr add user –name=xiaoming -account=China -level=admin 主要参数 account： 账户名 level： 用户权限 Admin： 系统管理员 Operator： 账户管理员 None： 普通用户 name： 用户名 partition： 可使用的分区名 3. 删除用户 系统管理员可以删除任意账户下的用户， 账户管理员可以删除同一账户下的新用户。 cacctmgr delete user xiaohong 4. 删除账户 仅系统管理员可以删除账户 cacctmgr delete account TEST 5. 查找用户 所有用户均可以使用查询功能 cacctmgr find user xiaohong 6. 查找账户 cacctmgr cacctmgr find account TEST 7. 修改账户 系统管理员可以修改任意信息， 账户管理员可以修改本身账户的信息，但不能更改账户的父账户。 cacctmgr add account -name=China -describe=motherland 主要参数 Qos： 服务质量 describe： 账户描述信息 name： 账户名 parent： 父账户 partition： 可使用的分区名 type： 对账户运行的分区操作 add： 默认是添加操作 delete: 删除 overwrite： 覆盖 8. 修改用户 系统管理员可以修改任意信息， 账户管理员可以修改同账户下用户的信息，但不能更改用户的账户。 cacctmgr set user -name=xiaoming -L=admin 主要参数 account： 账户名 level： 用户权限 Admin： 系统管理员 Operator： 账户管理员 None： 普通用户 name： 用户名 partition： 可使用的分区名 9. 显示账户树 系统管理员会显示数据库所有根账户的账户树， 账户管理员和用户会显示本身账户的账户树。 cacctmgr show accounts 10. 显示用户 系统管理员会显示所有用户， 账户管理员和用户会显示同一账户下的所有用户。 cacctmgr show users "}}